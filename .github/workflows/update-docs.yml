name: Update Documentation

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  update-docs:
    name: Update Antora Playbook
    runs-on: ubuntu-latest

    steps:
      - name: Validate release tag format
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Validating release tag: $TAG"

          if [[ ! "$TAG" =~ ^[0-9]+(\.[0-9]+)?\.x$ ]]; then
            echo "❌ Invalid release tag format: $TAG"
            echo "Expected: <major>.x or <major>.<minor>.x"
            exit 1
          fi

          echo "✅ Release tag format is valid"

      - name: Checkout quarkiverse-docs
        uses: actions/checkout@v4
        with:
          repository: quarkiverse/quarkiverse-docs
          path: quarkiverse-docs

      - name: Update antora-playbook.yml
        run: |
          TAG="${{ github.event.release.tag_name }}"
          cd quarkiverse-docs

          yq e '
            (.content.sources[] 
              | select(.url == "https://github.com/quarkiverse/quarkus-openapi-generator.git")
              | .tags) as $tags
            | if ($tags | index(strenv(TAG))) == null then
                (.content.sources[] 
                  | select(.url == "https://github.com/quarkiverse/quarkus-openapi-generator.git")
                  | .tags += [strenv(TAG)])
              else .
              end
          ' -i antora-playbook.yml

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd quarkiverse-docs
          BRANCH="docs/openapi-generator-${{ github.event.release.tag_name }}"

          git checkout -b "$BRANCH"
          git add antora-playbook.yml
          git commit -m "docs(openapi-generator): add version ${{ github.event.release.tag_name }}"

          git push origin "$BRANCH"

          gh pr create \
            --title "docs(openapi-generator): add version ${{ github.event.release.tag_name }}" \
            --body "Automated PR to add documentation for release ${{ github.event.release.tag_name }} of quarkus-openapi-generator." \
            --base main \
            --head "$BRANCH"
