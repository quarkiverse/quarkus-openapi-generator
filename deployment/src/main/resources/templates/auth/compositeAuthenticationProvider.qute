package {apiPackage}.auth;

import javax.inject.Inject;
import javax.annotation.PostConstruct;
import javax.ws.rs.Priorities;

import io.quarkus.arc.Priority;

import io.quarkiverse.openapi.generator.OpenApiGeneratorConfig;

{#if hasHttpBasicMethods}
import io.quarkiverse.openapi.generator.providers.BasicAuthenticationProvider;
{/if}
{#if hasApiKeyMethods}
import io.quarkiverse.openapi.generator.providers.ApiKeyAuthenticationProvider;
import io.quarkiverse.openapi.generator.providers.ApiKeyIn;
{/if}
{#if hasHttpBearerMethods}
import io.quarkiverse.openapi.generator.providers.BearerAuthenticationProvider;
{/if}
{#if hasOAuthMethods}
import io.quarkiverse.openapi.generator.providers.OAuth2AuthenticationProvider;
{/if}
import io.quarkiverse.openapi.generator.providers.AbstractCompositeAuthenticationProvider;
import io.quarkiverse.openapi.generator.providers.OperationAuthInfo;

@Priority(Priorities.AUTHENTICATION)
public class CompositeAuthenticationProvider extends AbstractCompositeAuthenticationProvider {

    @Inject
    OpenApiGeneratorConfig generatorConfig;

    @PostConstruct
    public void init() {
        {#for auth in httpBasicMethods.orEmpty}
        BasicAuthenticationProvider basicAuthProvider = new BasicAuthenticationProvider("{quarkus-generator.openApiSpecId}", sanitizeAuthName("{auth.name}"), generatorConfig);
        this.addAuthenticationProvider(basicAuthProvider);
        {#for api in apiInfo.apis}
        {#for op in api.operations.operation}
        {#if op.hasAuthMethods}
        {#for authM in op.authMethods}
        {#if authM.name == auth.name}
        basicAuthProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {#else if defaultSecurityScheme == auth.name}
        basicAuthProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {/for}
        {/for}
        {#for auth in oauthMethods.orEmpty}
        OAuth2AuthenticationProvider oAuth2Provider = new OAuth2AuthenticationProvider("{quarkus-generator.openApiSpecId}", sanitizeAuthName("{auth.name}"), generatorConfig);
        this.addAuthenticationProvider(oAuth2Provider);
        {#for api in apiInfo.apis}
        {#for op in api.operations.operation}
        {#if op.hasAuthMethods}
        {#for authM in op.authMethods}
        {#if authM.name == auth.name}
        oAuth2Provider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {#else if defaultSecurityScheme == auth.name}
        oAuth2Provider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {/for}
        {/for}
        {#for auth in httpBearerMethods.orEmpty}
        BearerAuthenticationProvider bearerProvider = new BearerAuthenticationProvider("{quarkus-generator.openApiSpecId}", sanitizeAuthName("{auth.name}"), "{auth.scheme}", generatorConfig);
        this.addAuthenticationProvider(bearerProvider);
        {#for api in apiInfo.apis}
        {#for op in api.operations.operation}
        {#if op.hasAuthMethods}
        {#for authM in op.authMethods}
        {#if authM.name == auth.name}
        bearerProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {#else if defaultSecurityScheme == auth.name}
        bearerProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {/for}
        {/for}
        {#for auth in apiKeyMethods.orEmpty}
        {#if auth.isKeyInQuery}
        ApiKeyAuthenticationProvider apiKeyQueryProvider = new ApiKeyAuthenticationProvider("{quarkus-generator.openApiSpecId}", sanitizeAuthName("{auth.name}"), ApiKeyIn.query, "{auth.keyParamName}", generatorConfig);
        this.addAuthenticationProvider(apiKeyQueryProvider);
        {#for api in apiInfo.apis}
        {#for op in api.operations.operation}
        {#if op.hasAuthMethods}
        {#for authM in op.authMethods}
        {#if authM.name == auth.name}
        apiKeyQueryProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {#else if defaultSecurityScheme == auth.name}
        apiKeyQueryProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {/for}
        {/if}
        {#if auth.isKeyInHeader}
        ApiKeyAuthenticationProvider apiKeyHeaderProvider = new ApiKeyAuthenticationProvider("{quarkus-generator.openApiSpecId}", sanitizeAuthName("{auth.name}"), ApiKeyIn.header, "{auth.keyParamName}", generatorConfig);
        this.addAuthenticationProvider(apiKeyHeaderProvider);
        {#for api in apiInfo.apis}
        {#for op in api.operations.operation}
        {#if op.hasAuthMethods}
        {#for authM in op.authMethods}
        {#if authM.name == auth.name}
        apiKeyHeaderProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {#else if defaultSecurityScheme == auth.name}
        apiKeyHeaderProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {/for}
        {/if}
        {#if auth.isKeyInCookie}
        ApiKeyAuthenticationProvider apiKeyCookieProvider = new ApiKeyAuthenticationProvider("{quarkus-generator.openApiSpecId}", sanitizeAuthName("{auth.name}"), ApiKeyIn.cookie, "{auth.keyParamName}", generatorConfig);
        this.addAuthenticationProvider(apiKeyCookieProvider);
        {#for api in apiInfo.apis}
        {#for op in api.operations.operation}
        {#if op.hasAuthMethods}
        {#for authM in op.authMethods}
        {#if authM.name == auth.name}
        apiKeyCookieProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {#else if defaultSecurityScheme == auth.name}
        apiKeyCookieProvider.addOperation(OperationAuthInfo.builder()
            .withPath("{api.contextPath}{api.commonPath}{op.path.orEmpty}")
            .withId("{op.operationId}")
            .withMethod("{op.httpMethod}")
            .build());
        {/if}
        {/for}
        {/for}
        {/if}
        {/for}
    }

}